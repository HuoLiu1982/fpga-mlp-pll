Problems: 方波数据集好像有问题，导致精度下降（maybe 缩小占空比的参数）
PS E:\my_FPGA\LMLP\7_20251108> python -u "e:\my_FPGA\LMLP\7_20251108\合理批量无需处理.py"
BatchNorm参数预计算完成，保存到: batchnorm_params.json

BatchNorm参数数值范围:
  bn1_scale: min=0.3941, max=6.2944, mean=2.1068
  bn1_shift: min=-6.7840, max=7.4005, mean=0.0682
  bn2_scale: min=0.6213, max=1.8501, mean=1.1904
  bn2_shift: min=-4.6771, max=1.5234, mean=0.1256
LUT Verilog文件已生成: ./mlp_luts.v
权重ROM文件已生成: ./mlp_weights_q10_22.dat
写入 2048 个32位定点数
开始验证修复后的FPGA实现...
使用Q10.22格式
预计算BatchNorm参数...
BatchNorm参数预计算完成
转换 layer1_weight       : 形状(32, 64)
转换 layer1_bias         : 形状(32,)
转换 layer2_weight       : 形状(16, 32)
转换 layer2_bias         : 形状(16,)
转换 output_weight       : 形状(4, 16)
转换 output_bias         : 形状(4,)
正在生成信号数据集...
信号类型分布:
  正弦波: 1291 样本 (25.8%)
  方波: 1410 样本 (28.2%)
  三角波: 1283 样本 (25.7%)
  其他: 1016 样本 (20.3%)
数据集生成完成: 5000个样本
测试样本数量: 5000

开始逐样本验证...
处理样本 0/5000

样本 1:
  真实类别: 0
  FPGA预测: 0, 输出值: 7.1967
  PyTorch预测: 0, 输出值: 7.1965
  各类别输出值对比:
    类别0: FPGA=  7.1967, PyTorch=  7.1965, 误差=  0.0003
    类别1: FPGA=-11.8810, PyTorch=-11.8806, 误差=  0.0004
    类别2: FPGA=  0.0084, PyTorch=  0.0082, 误差=  0.0002
    类别3: FPGA=-14.2601, PyTorch=-14.2598, 误差=  0.0003

样本 2:
  真实类别: 1
  FPGA预测: 1, 输出值: 8.1520
  PyTorch预测: 1, 输出值: 8.1521
  各类别输出值对比:
    类别0: FPGA=-61.3529, PyTorch=-61.3532, 误差=  0.0003
    类别1: FPGA=  8.1520, PyTorch=  8.1521, 误差=  0.0001
    类别2: FPGA=  0.8329, PyTorch=  0.8328, 误差=  0.0002
    类别3: FPGA=  1.1556, PyTorch=  1.1558, 误差=  0.0002

样本 3:
  真实类别: 2
  FPGA预测: 2, 输出值: 3.4323
  PyTorch预测: 2, 输出值: 3.4322
  各类别输出值对比:
    类别0: FPGA=-17.7880, PyTorch=-17.7889, 误差=  0.0009
    类别1: FPGA= -6.1835, PyTorch= -6.1831, 误差=  0.0004
    类别2: FPGA=  3.4323, PyTorch=  3.4322, 误差=  0.0001
    类别3: FPGA= -3.8204, PyTorch= -3.8200, 误差=  0.0004
处理样本 1000/5000
处理样本 2000/5000
处理样本 3000/5000
处理样本 4000/5000

============================================================
修复后的验证结果总结:
============================================================
FPGA定点推理准确率: 99.18%
PyTorch浮点推理准确率: 99.18%
两者一致率: 99.18%
精度下降: 0.00%

✅ FPGA实现验证通过！


